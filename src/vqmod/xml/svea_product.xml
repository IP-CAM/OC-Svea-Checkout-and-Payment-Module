<?xml version="1.0" encoding="UTF-8"?>
<modification>
    <id>SveaWebPay Product Price</id>
    <version>4.5.2</version>
    <vqmver>2.6.3</vqmver>
    <author>Anneli Halld'n, Kristian Grossman-Madsen / Svea Ekonomi AB, SveaWebPay</author>
    <file name="catalog/controller/product/product.php">
        <!--inserted after line 319 where $data['price'] is being set in controller product.php -->
        <operation name="svea controller load data to view">
            <search position="before"><![CDATA[  $data['options'] = array(); ]]></search>
            <add><![CDATA[

                    $paymentString = "payment_";
                    if(VERSION < 3.0)
                    {
                        $paymentString = "";
                    }

                    $this->load->model('localisation/country');
                    $this->load->model('extension/payment/svea_partpayment');
                    $this->load->language('extension/payment/svea_partpayment');
                    $this->load->language('extension/svea/checkout');

                    $svea_country = $this->model_localisation_country->getCountry($this->config->get('config_country_id'));
                    $svea_show_paymentplan = $this->model_extension_payment_svea_partpayment->getProductPriceMode();

                    $calculate_price = isset($product_info['special']) ? $product_info['special'] : $product_info['price'];
                    if ($svea_show_paymentplan === '1' && $svea_country['iso_code_2'] != "DE") {
                        $currency_decimals = $this->session->data['currency'] == 'EUR' ? 1 : 0;
                        $prices = array();

                        $symbolRight = $this->currency->getSymbolRight($this->session->data['currency']);
                        $symbolLeft = $this->currency->getSymbolLeft($this->session->data['currency']);
                        $currency_converted_price = floatval($this->tax->calculate($this->currency->format($calculate_price, $this->session->data['currency'], false, false), $product_info['tax_class_id'], $this->config->get('config_tax')));

                        if ($svea_show_paymentplan === '1' && $svea_country['iso_code_2'] != "NL") {


                            $q = "SELECT `campaignCode`,`description`,`paymentPlanType`,`contractLengthInMonths`,
                                                        `monthlyAnnuityFactor`,`initialFee`, `notificationFee`,`interestRatePercent`,
                                                        `numberOfInterestFreeMonths`,`numberOfPaymentFreeMonths`,`fromAmount`,`toAmount`
                                                        FROM `" . DB_PREFIX . "svea_params_table`
                                                        WHERE `timestamp`=(SELECT MAX(timestamp) FROM `" . DB_PREFIX . "svea_params_table` WHERE `countryCode` = '" . $svea_country['iso_code_2'] . "')
                                                        AND `countryCode` = '" . $svea_country['iso_code_2'] . "'
                                                        ORDER BY `monthlyAnnuityFactor` ASC";

                            $query = $this->db->query($q);
                            $campaigns = $query->rows;
                            $priceList = $this->sveaPaymentPlanParamsHelper($currency_converted_price, $campaigns);
                            $lowestCampaign = array();
                            if($svea_country['iso_code_2'] == "NO" || $svea_country['iso_code_2'] == "DK" || $svea_country['iso_code_2'] == "NL"){
                                $logoImg = "http://cdn.svea.com/sveafinans/rgb_svea-finans_small.png";
                            }
                            else
                            {
                                $logoImg = "http://cdn.svea.com/sveaekonomi/rgb_ekonomi_small.png";
                            }

                            if (sizeof($priceList)) {//&& admin settings for product display is set to yes
                                foreach ($priceList as $value) {
                                    if(empty($lowestCampaign) || $value['pricePerMonth'] < $lowestCampaign['pricePerMonth'] && $value['paymentPlanType'] == 0)
                                    {
                                        $lowestCampaign = $value;
                                    }
                                }
                                $data[$paymentString . 'svea_widget'] =  '<p class="wp-product-widget">
                                                    <img style="width:80px; height:40px;" src="'. $logoImg . '"><span style="font-size:15px">' . $this->language->get('widget_pay_monthly') . ' ' . $symbolLeft . ceil($lowestCampaign['pricePerMonth']) . $symbolRight . "/" . $this->language->get('widget_month'). "</span>";
                            }
                    }
                }
       ]]></add>
        </operation>
        <!--inserted somewhere as their own functions in controller product.php -->
        <operation name="svea controller helper functions">
            <search position="before"><![CDATA[  public function write() { ]]></search>
            <add><![CDATA[
                    /**
                     * svea helper function
                     */
                    private function sveaPaymentPlanParamsHelper($price,$params){
                        $values = array();
                                if (!empty($params)) {
                        foreach ($params as $key => $value) {
                              if ($price >= $value['fromAmount'] && $price <= $value['toAmount']) {
                                $pair = array();
                                $pair['pricePerMonth'] = ($value['initialFee'] + (ceil($price * $value['monthlyAnnuityFactor']) + $value['notificationFee']) * $value['contractLengthInMonths']) / $value['contractLengthInMonths'];

                                foreach ($value as $key => $val) {
                                    if ($key == 'campaignCode') {
                                        $pair[$key] = $val;
                                    }

                                if($key == 'description'){
                                    $pair[$key] = $val;
                                }

                                if($key == 'paymentPlanType')
                                    $pair[$key] = $val;
                                }
                                array_push($values, $pair);
                              }

                            }
                        }
                    return $values;
                    }
       ]]></add>
        </operation>
    </file>
    <file name="catalog/view/theme/*/template/product/product.tpl">
        <!--inserted between cart and review divs in product.tpl -->
        <operation name="wp widget for OC 2.3-">
            <search position="before">
                <![CDATA[  <div id="product">  ]]> </search>
            <add><![CDATA[
                        <?php
                    if (isset($svea_widget)) {
                    echo $svea_widget;
                    } ?>

            ]]></add>
        </operation>
    </file>
    <file name="catalog/view/theme/*/template/product/product.twig">
        <operation name="wp widget for OC 3.0+">
            <search position="before">
                <![CDATA[  <div id="product">  ]]> </search>
            <add><![CDATA[
            {% if payment_svea_widget is defined %}
            {{ payment_svea_widget }}
            {% endif %}
            ]]></add>
        </operation>
    </file>
</modification>