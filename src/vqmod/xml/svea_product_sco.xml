<?xml version="1.0" encoding="UTF-8"?>
<modification>
    <id>Svea Checkout Product Price</id>
    <version>4.5.2</version>
    <vqmver>2.6.3</vqmver>
    <author>Fredrik Sundell / Svea Ekonomi AB, Svea WebPay</author>
    <file name="catalog/controller/product/product.php">
        <operation name="svea controller load data to view">
            <search position="before"><![CDATA[  $data['options'] = array(); ]]></search>
            <add><![CDATA[

                    $userTokenString = "user_";
                    $linkString = "marketplace/extension";
                    $paymentString ="payment_";
                    $moduleString = "module_";
                    $appendString = "_before";
                    $eventString = "setting/event";

                    if(VERSION < 3.0)
                    {
                        $userTokenString = "";
                        $linkString = "extension/extension";
                        $paymentString = "";
                        $moduleString = "";
                        $appendString = "";
                        $eventString = "extension/event";
                    }

                    $data['scoShowWidget'] = $this->config->get($moduleString . 'sco_show_widget_on_product_page');

                    if ($data['scoShowWidget'] === '1') {

                    $this->load->model('localisation/country');
                    $this->load->language('extension/svea/checkout');

                    $country = $this->model_localisation_country->getCountry($this->getCheckoutCountry());

                    $productPrice = isset($product_info['special']) ? $product_info['special'] : $product_info['price'];

                    $currency_decimals = $this->session->data['currency'] == 'EUR' ? 1 : 0;

                    $symbolRight = $this->currency->getSymbolRight($this->session->data['currency']);
                    $symbolLeft = $this->currency->getSymbolLeft($this->session->data['currency']);
                    $currency_converted_price = floatval($this->tax->calculate($this->currency->format($productPrice, $this->session->data['currency'], false, false), $product_info['tax_class_id'], $this->config->get('config_tax')));

                    $q = "SELECT `campaignCode`,`description`,`paymentPlanType`,`contractLengthInMonths`,
                                                `monthlyAnnuityFactor`,`initialFee`, `notificationFee`,`interestRatePercent`,
                                                `numberOfInterestFreeMonths`,`numberOfPaymentFreeMonths`,`fromAmount`,`toAmount`
                                                FROM `" . DB_PREFIX . $moduleString . "sco_campaigns`
                                                WHERE `timestamp`=(SELECT MAX(timestamp) FROM `" . DB_PREFIX . $moduleString . "sco_campaigns` WHERE `countryCode` = '" . $country['iso_code_2'] . "')
                                                AND `countryCode` = '" . $country['iso_code_2'] . "'
                                                ORDER BY `monthlyAnnuityFactor` ASC";

                    $query = $this->db->query($q);
                    $campaigns = $query->rows;
                    $priceList = $this->sveaPaymentPlanParamsHelper($currency_converted_price, $campaigns);
                    $lowestCampaign = array();
                    if($country['iso_code_2'] == "NO" || $country['iso_code_2'] == "DK" || $country['iso_code_2'] == "NL"){
                        $logoImg = "http://cdn.svea.com/sveafinans/rgb_svea-finans_small.png";
                    }
                    else
                    {
                        $logoImg = "http://cdn.svea.com/sveaekonomi/rgb_ekonomi_small.png";
                    }

                    if (sizeof($priceList)) {//&& admin settings for product display is set to yes
                        foreach ($priceList as $value) {
                            if(empty($lowestCampaign) || $value['pricePerMonth'] < $lowestCampaign['pricePerMonth'] && $value['paymentPlanType'] == 0)
                            {
                                $lowestCampaign = $value;
                            }
                        }
                        $data['sco_svea_widget'] =  '<p class="sco-product-widget">
                                                    <img style="width:80px; height:40px;" src="'. $logoImg . '"><span style="font-size:15px">' . $this->language->get('widget_pay_monthly') . ' ' . $symbolLeft . ceil($lowestCampaign['pricePerMonth']) . $symbolRight . "/" . $this->language->get('widget_month'). "</span>";

                    }

                    }
       ]]></add>
        </operation>
        <operation name="sco controller helper functions">
            <search position="before"><![CDATA[  public function write() { ]]></search>
            <add><![CDATA[
                    public function getCheckoutCountry()
                    {
                        $moduleString = "module_";

                        if(VERSION < 3.0)
                        {
                            $moduleString = "";
                        }

                        if($this->request->cookie['language'] == "sv-se")
                        {
                            return 203;
                        }
                        else if($this->request->cookie['language'] == "nn-no")
                        {
                            return 160;
                        }
                        else if($this->request->cookie['language'] == "fi-fi")
                        {
                            return 72;
                        }
                        else
                        {
                            return $this->config->get($moduleString . 'sco_checkout_default_country_id');
                        }
                    }
       ]]></add>
        </operation>
    </file>
    <file name="catalog/view/theme/*/template/product/product.twig">
        <!--inserted between cart and review divs in product.twig -->
        <operation name="sco widget for OC 3.0+">
            <search position="before">
                <![CDATA[  <div id="product">  ]]> </search>
            <add><![CDATA[
            {% if scoShowWidget is defined and scoShowWidget == 1 %}
            {{ sco_svea_widget }}
            {% endif %}
            ]]></add>
        </operation>
    </file>
    <file name="catalog/view/theme/*/template/product/product.tpl">
        <!--inserted between cart and review divs in product.tpl -->
        <operation name="sco widget for OC 2.3-">
            <search position="before">
                <![CDATA[  <div id="product">  ]]> </search>
            <add><![CDATA[
            <?php if($scoShowWidget)
            {
                echo $sco_svea_widget;
            }
            ?>]]></add>
        </operation>
    </file>
</modification>